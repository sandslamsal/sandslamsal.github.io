!function(e){"use strict";const t={};void 0===e&&(e="undefined"!=typeof window?window:{}),t.factors={beta1:e=>{if(!isFinite(e))return.85;const t=.85-(e-28)/7*.05;return Math.max(.65,Math.min(.85,t))},phiFlex:()=>.9,phiShear:()=>.75,phiPunch:()=>.75,lambda:()=>1},t.mean=e=>e.length?e.reduce((e,t)=>e+t,0)/e.length:0,t.clone=e=>JSON.parse(JSON.stringify(e)),t.parseCoordsText=e=>e.split(/\n+/).map(e=>e.trim()).filter(Boolean).map(e=>{const t=e.split(/[\s,]+/).map(Number).filter(e=>!isNaN(e));if(t.length<2)throw new Error("Invalid coord line: "+e);return{x:t[0],y:t[1]}}),t.parseMultiLoadCases=e=>{const t=e.split(/\n+/).map(e=>e.trim()).filter(Boolean),a=[];for(const e of t){const t=e.split(/[\s,]+/).filter(Boolean);if(t.length<4)throw new Error("Line needs name P Mx My: "+e);const[i,n,o,r]=t,s=parseFloat(n),c=parseFloat(o),m=parseFloat(r);if([s,c,m].some(e=>isNaN(e)))throw new Error("Non-numeric: "+e);a.push({name:i,P:s,Mx:c,My:m})}return a},t.computeReactionsRigid=({P:e,Mx:a,My:i,coords:n,activeMask:o=null})=>{const r=n.map((e,t)=>({...e,active:!o||o[t]})),s=r.filter(e=>e.active);if(!s.length)throw new Error("No active piles for reaction distribution");const c=t.mean(s.map(e=>e.x)),m=t.mean(s.map(e=>e.y)),l=r.map(e=>({x:e.x-c,y:e.y-m,active:e.active})),h=s.length;let f=0,u=0,p=0;l.forEach(e=>{e.active&&(f+=e.x*e.x,u+=e.y*e.y,p+=e.x*e.y)});const _=e/h,x=f*u-p*p,M=1e-12;let d=0,y=0;Math.abs(x)>M?(d=(u*i-p*a)/x,y=(-p*i+f*a)/x):(d=f?i/f:0,y=u?a/u:0);const P=n.map((e,t)=>{if(o&&!r[t].active)return{index:t+1,x:e.x,y:e.y,R:0,inactive:!0};const a=l[t],i=_+d*a.x+y*a.y;return{index:t+1,x:e.x,y:e.y,R:i}}),N=Math.max(...P.map(e=>e.R)),b=Math.min(...P.map(e=>e.R));return{reactions:P,Pmax:N,Pmin:b,cx:c,cy:m,a:_,b:d,c:y,Sxx:f,Syy:u,Sxy:p}},t.computeReactionsIterative=({P:e,Mx:a,My:i,coords:n,maxLoops:o=20})=>{let r=new Array(n.length).fill(!0),s=-1,c=null;for(let m=0;m<o;m++){c=t.computeReactionsRigid({P:e,Mx:a,My:i,coords:n,activeMask:r});const o=c.reactions.map((e,t)=>({r:e,i:t})).filter(e=>e.r.R<0&&r[e.i]);if(!o.length)break;if(o.length===s)break;o.forEach(e=>r[e.i]=!1),s=o.length}const m=c.reactions.filter(e=>e.R>0),l=m.reduce((e,t)=>e+t.R,0);if(l>0){const t=e/l;m.forEach(e=>e.R*=t)}return c.Pmax=Math.max(...c.reactions.map(e=>e.R)),c.Pmin=Math.min(...c.reactions.map(e=>e.R)),c.iterative=!0,c},t.punchingChecks=({fcMPa:e,pileDia_m:a,capThk_m:i},n)=>{const o=t.factors.phiPunch(e),r=.8*i,s=[];for(const t of n.reactions){if(t.R<=0)continue;const i=Math.PI*(a+r),n=1e3*i,c=1e3*r,m=o*(.33*Math.sqrt(e)*n*c/1e3),l=t.R,h=m>0?l/m:1/0;s.push({pile:t.index,Vu_kN:l,phiVc_kN:m,utilisation:h,OK:h<=1,d_m:r,b0_m:i})}if(!s.length)return{governing:null,perPile:[]};return{governing:s.reduce((e,t)=>t.utilisation>e.utilisation?t:e,s[0]),perPile:s}},t.flexureCapacity=({Mu_kNm:e,b_m:t,d_m:a,fc_MPa:i,fy_MPa:n,phi:o})=>{const r=1e6*e,s=1e3*t,c=1e3*a;let m=1e3;for(let e=0;e<200;e++){const e=c-m*n/(.85*i*s)/2,t=o*(m*n*e);if(t>=r)break;const a=(r-t)/(n*Math.max(e,1));m+=Math.max(5,a)}const l=.0018*s*(a/.8*1e3);m=Math.max(m,l);return{phiMn_kNm:o*(m*n*(c-m*n/(.85*i*s)/2))/1e6,As_req_mm2:m,As_min_mm2:l}},t.oneWayShear=({Vu_kN:e,b_m:t,d_m:a,fc_MPa:i,phi:n,lambda:o=1})=>{const r=1e3*t,s=1e3*a,c=n*(.17*o*Math.sqrt(i)*r*s/1e3),m=c>0?e/c:1/0;return{Vu_kN:e,phiVc_kN:c,util:m,OK:m<=1}},t.deriveStrengthDemands=(e,t,a,i)=>{let n=0,o=0;for(const i of e){const e=Math.abs(i.x),r=Math.abs(i.y);r>a/2&&(n+=i.R*(r-a/2)),e>t/2&&(o+=i.R*(e-t/2))}const r=t/2+i,s=-r,c=a/2+i,m=-c;let l=0,h=0,f=0,u=0;for(const t of e)t.x>r&&(f+=t.R),t.x<s&&(u+=t.R),t.y>c&&(l+=t.R),t.y<m&&(h+=t.R);return{Mu_x:n,Mu_y:o,Vu_x:Math.max(l,h,0),Vu_y:Math.max(f,u,0)}},t.multiCaseStrength=(e,a)=>{const{colx:i,coly:n,d_eff:o,fc:r,fy:s,phiF:c,phiV:m,b_x:l,b_y:h}=a;let f=0,u=0,p=0,_=0;for(const a of e){const e=t.deriveStrengthDemands(a.sol.reactions,i,n,o);a.demands=e,f=Math.max(f,e.Mu_x),u=Math.max(u,e.Mu_y),p=Math.max(p,e.Vu_x),_=Math.max(_,e.Vu_y)}const x=t.flexureCapacity({Mu_kNm:f,b_m:l,d_m:o,fc_MPa:r,fy_MPa:s,phi:c}),M=t.flexureCapacity({Mu_kNm:u,b_m:h,d_m:o,fc_MPa:r,fy_MPa:s,phi:c}),d=t.oneWayShear({Vu_kN:p,b_m:l,d_m:o,fc_MPa:r,phi:m}),y=t.oneWayShear({Vu_kN:_,b_m:h,d_m:o,fc_MPa:r,phi:m});for(const t of e){const e=t.demands;t.flexUtilX=e.Mu_x/(x.phiMn_kNm||1e-9),t.flexUtilY=e.Mu_y/(M.phiMn_kNm||1e-9),t.owsUtilX=e.Vu_x/(d.phiVc_kN||1e-9),t.owsUtilY=e.Vu_y/(y.phiVc_kN||1e-9)}return{solutions:e,fx:x,fyres:M,owsX:d,owsY:y}},t.flexureFromProvided=({As_mm2:e,b_m:t,d_m:a,fc_MPa:i,fy_MPa:n,phi:o})=>({phiMn_kNm:o*(e*n*(1e3*a-e*n/(.85*i*(1e3*t))/2))/1e6}),"undefined"!=typeof module&&module.exports?module.exports=t:e.PileCapCore=t}("undefined"!=typeof global?global:this);