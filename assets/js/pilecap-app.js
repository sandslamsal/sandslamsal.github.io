!function(){"use strict";function t(t){return document.getElementById(t)}function e(e,n="info"){const o=t("pc-status");o&&(o.textContent=e,o.className="pc-status "+n)}function n(t){const e=t.split(/\r?\n/).map(t=>t.trim()).filter(Boolean),n=[],o=/[-+]?\d*\.?\d+(?:[eE][-+]?\d+)?/g;return e.forEach(t=>{const e=t.match(o);if(e&&e.length>=2){const t=parseFloat(e[0]),o=parseFloat(e[1]);isFinite(t)&&isFinite(o)&&n.push({x:t,y:o})}}),n}function o(){try{const o=parseFloat(t("pc-load-p").value),i=parseFloat(t("pc-mx").value)||0,s=parseFloat(t("pc-my").value)||0,c=parseFloat(t("pc-allow-comp").value)||1/0,l=parseFloat(t("pc-allow-ten").value)||0,d=parseFloat(t("pc-fc").value)||0,u=parseFloat(t("pc-diameter").value)||.4,p=parseFloat(t("pc-cap-thk").value)||.9;if(!(o>0))return e("Enter positive axial load P","error");const h=n(t("pc-coords").value);if(h.length<3)return e("Need at least 3 piles","error");const x=h.reduce((t,e)=>t+e.x,0)/h.length,m=h.reduce((t,e)=>t+e.y,0)/h.length,f=h.map(t=>({x:t.x-x,y:t.y-m})),g=f.length;let y=0,M=0,F=0;f.forEach(t=>{y+=t.x*t.x,M+=t.y*t.y,F+=t.x*t.y});const R=o/g,$=y*M-F*F;let v=0,b=0,k=!1;Math.abs($)>1e-12?(v=(s*M- -i*F)/$,b=(y*-i-F*s)/$,k=!0):(v=y?s/y:0,b=M?-i/M:0);const T=f.map(t=>R+v*t.x+b*t.y),E=Math.max(...T),P=Math.min(...T),N=T.filter(t=>t<0).length,C=T.map((t,e)=>{let n="",o="OK";if(t>=0)n=c&&isFinite(c)?(t/c*100).toFixed(1)+"%":"-",t>c&&(o="Over");else{const e=-t;n=l>0?(e/l*100).toFixed(1)+"%":"Tension",e>l&&(o="Over-Tension")}return{i:e+1,x:h[e].x,y:h[e].y,R:t,util:n,status:o}}),L=C.reduce((t,e,n,o)=>e.R>o[t].R?n:t,0),S=C[L].R,w=.8*p,I=Math.PI*(u+w),O=.33*Math.sqrt(d)*I*w;r({P:o,Mx:i,My:s,cx:x,cy:m,rows:C,maxR:E,minR:P,upliftCount:N,coupled:k,b:v,c:b,Rc:S,Vc:O,shearStatus:S>O?"Punching Demand > Capacity (Prelim)":"OK (Prelim)"}),a(C,x,m),e("Analysis complete","success")}catch(t){console.error(t),e("Error during analysis","error")}}function r(e){t("pc-results").hidden=!1,t("pc-summary").innerHTML=`<strong>Total Load P:</strong> ${e.P.toFixed(2)} kN<br>\n      <strong>Moments:</strong> Mx=${e.Mx.toFixed(2)} kN\xb7m, My=${e.My.toFixed(2)} kN\xb7m<br>\n      <strong>Centroid:</strong> (${e.cx.toFixed(3)}, ${e.cy.toFixed(3)}) m<br>\n      <strong>Max Reaction:</strong> ${e.maxR.toFixed(2)} kN<br>\n      <strong>Min Reaction:</strong> ${e.minR.toFixed(2)} kN<br>\n      <strong>Uplift Piles:</strong> ${e.upliftCount}<br>\n      <strong>Coupled Solution:</strong> ${e.coupled?"Yes":"No (degenerate layout)"}<br>`;const n=t("pc-table").querySelector("tbody");n.innerHTML="",e.rows.forEach(t=>{const e=document.createElement("tr");e.innerHTML=`<td>${t.i}</td><td>${t.x}</td><td>${t.y}</td><td>${t.R.toFixed(2)}</td><td>${t.util}</td><td class="${"OK"!==t.status?"warn":""}">${t.status}</td>`,t.R<0&&e.classList.add("uplift"),n.appendChild(e)}),t("pc-punch").innerHTML=`<h3>Punching Shear (Preliminary)</h3>\n      Critical pile #${e.rows.findIndex(t=>t.R===e.Rc)+1} Reaction Rc=${e.Rc.toFixed(2)} kN<br>\n      Nominal Vc \u2248 ${e.Vc.toFixed(2)} kN<br>\n      Status: <strong>${e.shearStatus}</strong>`}function a(e,n,o){function r(t){return l+(t-p)/f*(s.width-2*l)}function a(t){return s.height-(l+(t-x)/g*(s.height-2*l))}function i(t){if(t<0)return"#e74c3c";const e=(t-M)/(y-M||1),n=Math.round(200-120*e);return`rgb(50,${Math.round(80+120*e)},${n})`}const s=t("pc-plan");if(!s)return;const c=s.getContext("2d");c.clearRect(0,0,s.width,s.height);const l=40,d=e.map(t=>t.x),u=e.map(t=>t.y),p=Math.min(...d),h=Math.max(...d),x=Math.min(...u),m=Math.max(...u),f=h-p||1,g=m-x||1,y=Math.max(...e.map(t=>t.R)),M=Math.min(...e.map(t=>t.R));c.strokeStyle="#888",c.lineWidth=1,c.beginPath(),c.moveTo(r(p),a(o)),c.lineTo(r(h),a(o)),c.moveTo(r(n),a(x)),c.lineTo(r(n),a(m)),c.stroke(),e.forEach(t=>{const e=r(t.x),n=a(t.y);c.beginPath(),c.fillStyle=i(t.R),c.arc(e,n,10,0,2*Math.PI),c.fill(),c.strokeStyle="#222",c.stroke(),c.fillStyle="#000",c.font="12px Inter, sans-serif",c.fillText(t.i,e+12,n-12),c.fillText(t.R.toFixed(0)+"kN",e+12,n+4)}),c.fillStyle="#000",c.font="12px Inter, sans-serif",c.fillText("Red: Tension (uplift). Blue/Green: Compression.",l,l-10)}function i(){e("Example loaded","info")}document.addEventListener("DOMContentLoaded",()=>{const n=t("pc-analyze");n&&n.addEventListener("click",o),t("pc-example")?.addEventListener("click",i),t("pc-reset")?.addEventListener("click",()=>{e("Reset","info"),t("pc-results").hidden=!0})})}();