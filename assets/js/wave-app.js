!function(){"use strict";function e(e,t){console.log("[WaveApp] "+e,t||"")}function t(e,t){console.debug("[WaveApp][Debug] "+e,t||"")}function a(e,t){console.error("[WaveApp][Error] "+e,t)}function n(e,t,a=9.81){const n=2*Math.PI/t,i=n*n/a;let r=i;const o=1e-10;for(let t=0;t<100;t++){const t=(r*Math.tanh(r*e)-i)/(Math.tanh(r*e)+r*e*(1-Math.tanh(r*e)**2));if(r-=t,Math.abs(t)<o)break}return 2*Math.PI/r}function i(e,t){let a=e*e/b;for(let n=0;n<60;n++){const n=(b*a*Math.tanh(a*t)-e*e)/(b*Math.tanh(a*t)+b*a*t*(1/Math.cosh(a*t))**2);if(a-=n,Math.abs(n)<1e-10)break}return a}function r(e,t,a=.001){const n=e.length,i=e.reduce((e,t)=>e+t,0)/n,r=e.map(e=>e-i),o=[];for(let e=0;e<n-1;e++)if(r[e]<=0&&r[e+1]>0){const a=e*t-r[e]*t/(r[e+1]-r[e]);o.push(a)}const l=[];for(let e=0;e<o.length-1;e++){const i=o[e],s=o[e+1],c=Math.round(i/t),u=Math.round(s/t);if(u<n&&u>c){const e=r.slice(c,u+1),t=Math.max(...e)-Math.min(...e);t>a&&l.push({height:t,period:s-i,startTime:i,endTime:s})}}if(!l.length)return{nWaves:0,Hmean:0,Tmean:0,Hs:0,Ts:0,H10:0,waves:[]};const s=l.map(e=>e.height),c=l.map(e=>e.period),u=s.slice().sort((e,t)=>t-e),d=c.slice().sort((e,t)=>t-e),m=l.length,p=s.reduce((e,t)=>e+t,0)/m,h=c.reduce((e,t)=>e+t,0)/m,f=Math.floor(m/3),g=f?u.slice(0,f).reduce((e,t)=>e+t,0)/f:p,v=f?d.slice(0,f).reduce((e,t)=>e+t,0)/f:h,y=Math.floor(m/10);return{nWaves:m,Hmean:p,Tmean:h,Hs:g,Ts:v,H10:y?u.slice(0,y).reduce((e,t)=>e+t,0)/y:g,waves:l}}function o(e,t){return{re:e.re+t.re,im:e.im+t.im}}function l(e,t){return{re:e.re-t.re,im:e.im-t.im}}function s(e,t){return{re:e.re*t.re-e.im*t.im,im:e.re*t.im+e.im*t.re}}function c(e){return{re:e.re,im:-e.im}}function u(e,t){const a=t.re*t.re+t.im*t.im;return{re:(e.re*t.re+e.im*t.im)/a,im:(e.im*t.re-e.re*t.im)/a}}function d(e){return Math.hypot(e.re,e.im)}function m(e,t){const a=e.reduce((e,t)=>e+d(t.c1)**2,0),n=e.reduce((e,t)=>e+d(t.c2)**2,0),i=e.reduce((e,t)=>o(e,s(c(t.c1),t.c2)),{re:0,im:0}),r=(i.re,i.im,a*n-(i.re*i.re+i.im*i.im));if(Math.abs(r)<1e-16)return null;const m=e.reduce((e,a,n)=>o(e,s(c(a.c1),t[n])),{re:0,im:0}),p=e.reduce((e,a,n)=>o(e,s(c(a.c2),t[n])),{re:0,im:0});return{Ai:u(l(s({re:n,im:0},m),s(i,p)),{re:r,im:0}),Ar:u(l(s({re:a,im:0},p),s(c(i),m)),{re:r,im:0})}}function p(e,a,n,r,o=.05,l=null){if(3!==a.length)throw new Error("Three-gauge analysis requires exactly 3 gauges");const s=a[0].length,c=M.isPowerOfTwo(s)?s:M.nextPowerOfTwo(s),u=a.map(e=>{const t=e.reduce((e,t)=>e+t,0)/e.length,a=e.map(e=>e-t);return a.length<c?a.concat(new Array(c-a.length).fill(0)):a}).map(e=>e.map(e=>({re:e,im:0}))).map(e=>M.fft(e)),p=1/n,h=u[0].length,f=Math.floor(h/2),g=p/h;l||(l=p/2*.95);const v=[],y=[],w=[],x=[];for(let t=1;t<f;t++){const a=t*g;if(a<o||a>l)continue;const n=i(2*Math.PI*a,r);if(!isFinite(n)||n<=0)continue;const s=m(e.map(e=>({c1:{re:Math.cos(-n*e),im:Math.sin(-n*e)},c2:{re:Math.cos(n*e),im:Math.sin(n*e)}})),[u[0][t],u[1][t],u[2][t]]);if(!s)continue;const c=d(s.Ai)/(h/2),p=d(s.Ar)/(h/2);c<1e-6&&p<1e-6||(v.push(c),y.push(p),w.push(a),x.push({f:a,k:n,AiMag:c,ArMag:p}))}if(!v.length)return{Hi:0,Hr:0,Kr:0,validFrequencies:0,details:[]};const b=2*(v.reduce((e,t)=>e+t,0)/v.length),F=2*(y.reduce((e,t)=>e+t,0)/y.length),W=v.reduce((e,t)=>e+t*t,0)*g/2,H=y.reduce((e,t)=>e+t*t,0)*g/2,C=4*Math.sqrt(Math.max(W,0)),E=4*Math.sqrt(Math.max(H,0)),q=C||b,S=E||F,T=q?S/q:0;return t("Reflection summary",{count:v.length,Hi_mean:b,Hr_mean:F,Hi_spec:C,Hr_spec:E,Kr:T}),{Hi:q,Hr:S,Kr:T,validFrequencies:v.length,details:x,Hi_mean:b,Hr_mean:F,Hi_spec:C,Hr_spec:E}}function h(e){return document.getElementById(e)}function f(e){if(e)try{e.destroy()}catch(t){a("Destroy chart failed",t)}}function g(e){return{display:!0,text:e,font:{size:16,weight:"bold",family:"Inter, sans-serif"},color:"#2c3e50"}}function v(e,t,a){return{responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!0,text:e,font:{size:16,weight:"bold"}},legend:{display:!0,position:"top"},tooltip:{mode:"index",intersect:!1}},scales:{x:{display:!0,title:g(t),grid:{color:"rgba(0,0,0,0.1)"},ticks:{font:{size:12,family:"Inter, sans-serif"},color:"#34495e"}},y:{display:!0,title:g(a),grid:{color:"rgba(0,0,0,0.1)"},ticks:{font:{size:12,family:"Inter, sans-serif"},color:"#34495e"}}},animation:{duration:1e3,easing:"easeInOutQuart"}}}function y(e,t,a){const n=v(e,t,a);return n.plugins.legend.labels={usePointStyle:!0,pointStyle:"line",font:{size:14}},n.plugins.zoom={zoom:{wheel:{enabled:!0},pinch:{enabled:!0},mode:"xy"},pan:{enabled:!0,mode:"xy"}},n}function w(e,t,a,n){return{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{title:{display:!0,text:e,font:{size:16,weight:"bold"}},legend:{display:!0,position:"top"},tooltip:{callbacks:{title:e=>"Wave #"+e[0].label,label:e=>n(e)}}},scales:{x:{display:!0,title:g(t),grid:{display:!1},ticks:{font:{size:12,family:"Inter, sans-serif"},color:"#34495e"}},y:{display:!0,title:g(a),beginAtZero:!0,grid:{color:"rgba(0,0,0,0.1)"},ticks:{font:{size:12,family:"Inter, sans-serif"},color:"#34495e"}}},animation:{duration:1e3,easing:"easeInOutQuart"}}}function x(e,t,a){if(!e)return;const n=e.options.scales||{};n.x&&(n.x.title||(n.x.title={}),n.x.title.display=!0,n.x.title.text=t),n.y&&(n.y.title||(n.y.title={}),n.y.title.display=!0,n.y.title.text=a),e.update()}const b=9.81;class M{static isPowerOfTwo(e){return e&&0==(e&e-1)}static nextPowerOfTwo(e){return Math.pow(2,Math.ceil(Math.log2(e)))}static fft(e){const t=e.length;if(t<=1)return e;if(!this.isPowerOfTwo(t)){const a=this.nextPowerOfTwo(t),n=new Array(a).fill().map((a,n)=>n<t?e[n]:{re:0,im:0});return this.fft(n)}const a=new Array(t);for(let n=0;n<t;n++){let i=0;for(let e=1,a=n;e<t;e<<=1,a>>=1)i=i<<1|1&a;a[i]=e[n]}for(let e=2;e<=t;e*=2){const n=e/2,i={re:Math.cos(-2*Math.PI/e),im:Math.sin(-2*Math.PI/e)};for(let r=0;r<t;r+=e){let e={re:1,im:0};for(let t=0;t<n;t++){const o=a[r+t],l=r+t+n,s={re:a[l].re*e.re-a[l].im*e.im,im:a[l].re*e.im+a[l].im*e.re};a[r+t]={re:o.re+s.re,im:o.im+s.im},a[l]={re:o.re-s.re,im:o.im-s.im},e={re:e.re*i.re-e.im*i.im,im:e.re*i.im+e.im*i.re}}}}return a}static magnitude(e){return Math.hypot(e.re,e.im)}static phase(e){return Math.atan2(e.im,e.re)}}const F={depth:.3,waveFrequency:.75,samplingFrequency:100,gaugeSpacing:[0,.3,.9],generateData:function(e=20){const t=1/this.samplingFrequency,a=Math.floor(e/t),i=2*Math.PI*this.waveFrequency,r=1/this.waveFrequency,o=n(this.depth,r),l=2*Math.PI/o,s=.025,c=.008,u=.2,d=[];for(let e=0;e<a;e++){const a=e*t,n=[];for(let e=0;e<3;e++){const t=this.gaugeSpacing[e],r=s*Math.sin(l*t-i*a)+c*Math.sin(-l*t-i*a+u)+.003*Math.sin(1.5*i*a+.5*e);n.push(r.toFixed(6))}d.push(n)}return d}},W=F.generateData(20,20250208);let H=null,C=null,E=null,q=null,S=null;window.loadWavelengthExample=function(e=!0){h("water-depth").value=F.depth,h("wave-period").value=(1/F.waveFrequency).toFixed(2),e&&alert("Example loaded.")},window.calculateWavelength=function(){try{const t=parseFloat(h("water-depth").value),i=parseFloat(h("wave-period").value);if(!(t>0||i>0))return alert("Enter positive values.");const r=n(t,i),o=2*Math.PI/r,l=r/i,s=2*Math.PI/i,c=.5*(1+2*o*t/Math.sinh(2*o*t))*l;let u=t/r>.5?"Deep Water":t/r<.05?"Shallow Water":"Intermediate Water";h("wavelength-value").textContent=r.toFixed(3),h("wavelength-details").innerHTML=`<strong>Additional Parameters:</strong><br>\u2022 Wave Number (k): ${o.toFixed(4)} rad/m<br>\u2022 Wave Celerity (c): ${l.toFixed(2)} m/s<br>\u2022 Group Velocity (cg): ${c.toFixed(2)} m/s<br>\u2022 Relative Depth (h/L): ${(t/r).toFixed(3)}<br>\u2022 Water Regime: ${u}<br>\u2022 Angular Frequency: ${s.toFixed(3)} rad/s`,h("wavelength-result").style.display="block"}catch(e){a("Wavelength calc failed",e),alert("Error calculating wavelength.")}},window.loadWaveStatsExample=function(e=!0){const t=W.map(e=>parseFloat(e[0]));h("wave-data").value=t.map(e=>e.toFixed(6)).join("\n"),h("sampling-frequency").value=F.samplingFrequency,e&&alert("Wave stats example loaded.")},window.calculateWaveStats=function(){try{const t=h("wave-data").value.trim(),n=parseFloat(h("sampling-frequency").value);if(!(t&&n>0))return alert("Enter data and valid frequency");const i=t.split(/[\,\n\r\s]+/).map(e=>parseFloat(e)).filter(e=>!isNaN(e));if(i.length<10)return alert("Need at least 10 points");const o=1/n,l=r(i,o);if(!l.nWaves)return alert("No valid waves found");H=i,C=l;const s=i.length*o,c=l.waves.map(e=>e.height),u=Math.max(...c),d=Math.min(...c),m=Math.sqrt(c.reduce((e,t)=>e+(t-l.Hmean)**2,0)/l.nWaves);h("hs-value").textContent=l.Hs.toFixed(3),h("hmean-value").textContent=l.Hmean.toFixed(3),h("tmean-value").textContent=l.Tmean.toFixed(2),h("h10-value").textContent=l.H10.toFixed(3),h("wave-count-value").textContent=l.nWaves;const p=h("wave-stats-result");let f=p.querySelector(".additional-results");f||((f=document.createElement("div")).className="additional-results",p.appendChild(f)),f.innerHTML=`<strong>Extended Statistics:</strong><br>\u2022 Maximum Wave Height: ${u.toFixed(3)} m<br>\u2022 Minimum Wave Height: ${d.toFixed(3)} m<br>\u2022 Standard Deviation: ${m.toFixed(3)} m<br>\u2022 Significant Period (Ts): ${l.Ts.toFixed(2)} s<br>\u2022 Data Duration: ${s.toFixed(1)} s<br>\u2022 Sampling Rate: ${n} Hz<br>\u2022 Data Points: ${i.length}`,p.style.display="block",h("wave-stats-plot-controls").style.display="block"}catch(e){a("Wave stats failed",e),alert("Error analyzing wave data")}},window.loadReflectionExample=function(e=!0){h("gauge-positions").value=F.gaugeSpacing.join(", "),h("reflection-depth").value=F.depth,h("time-step").value=1/F.samplingFrequency;const t=W;h("gauge-data").value=t.map(e=>e.join(",")).join("\n"),e&&alert("Reflection example loaded.")},window.calculateReflection=function(){try{const n=h("gauge-positions").value.split(",").map(e=>parseFloat(e.trim())),i=parseFloat(h("reflection-depth").value),r=parseFloat(h("time-step").value),o=h("gauge-data").value.trim();if(3!==n.length||n.some(isNaN)||!(i>0)||!(r>0)||!o)return alert("Enter valid inputs");const l=o.split("\n").filter(e=>e.trim()),s=[];for(const e of l){const t=e.split(",").map(e=>parseFloat(e.trim()));3!==t.length||t.some(isNaN)||s.push(t)}if(s.length<10)return alert("Need at least 10 rows");E=s;const c=p(n,[s.map(e=>e[0]),s.map(e=>e[1]),s.map(e=>e[2])],r,i);h("hi-value").textContent=c.Hi.toFixed(3),h("hr-value").textContent=c.Hr.toFixed(3),h("kr-value").textContent=c.Kr.toFixed(3),h("freq-count-value").textContent=c.validFrequencies;const u=h("reflection-result");let d=u.querySelector(".additional-results");d||((d=document.createElement("div")).className="additional-results",u.appendChild(d));const m=c.Kr;let f=m<.3?"Low reflection - Good absorption":m<.7?"Moderate reflection - Partial absorption":"High reflection - Strong reflection";const g=s.length*r,v=Math.abs(n[1]-n[0]),y=(m*m*100).toFixed(1);d.innerHTML=`<strong>Analysis Details:</strong><br>\u2022 Gauge Spacing: ${v.toFixed(2)} m<br>\u2022 Data Duration: ${g.toFixed(1)} s<br>\u2022 Performance: ${f}<br>\u2022 Energy Reflection: ${y}%<br>\u2022 Data Points: ${s.length}<br>\u2022 Method: 3-gauge LSQ (freq-domain)`,u.style.display="block",h("reflection-plot-controls").style.display="block",t("Reflection frequencies sample",c.details.slice(0,5))}catch(e){a("Reflection failed",e),alert("Error analyzing reflection")}},window.plotWaveTimeSeries=function(){if(!H)return alert("No wave data");const e=1/parseFloat(h("sampling-frequency").value),t=H.map((t,a)=>(a*e).toFixed(3));f(q);const a=document.getElementById("wave-plot").getContext("2d");q=new Chart(a,{type:"line",data:{labels:t,datasets:[{label:"Wave Elevation (m)",data:H,borderColor:"#667eea",backgroundColor:"rgba(102,126,234,0.1)",borderWidth:2,pointRadius:0,tension:.1,fill:!0}]},options:v("Wave Time Series","Time t (s)","Wave Elevation \u03b7 (m)")}),h("wave-chart-title").textContent="Wave Time Series Plot",h("wave-plot-container").style.display="block",x(q,"Time t (s)","Wave Elevation \u03b7 (m)")},window.plotWaveHeights=function(){if(!C||!C.waves.length)return alert("No wave analysis results");const e=C.waves,t=e.map((e,t)=>t+1),a=e.map(e=>e.height),n=e.map(e=>e.period);f(q);const i=document.getElementById("wave-plot").getContext("2d");q=new Chart(i,{type:"bar",data:{labels:t,datasets:[{label:"Wave Height (m)",data:a,backgroundColor:"rgba(79,172,254,0.7)",borderColor:"#4facfe",borderWidth:2,borderRadius:4,borderSkipped:!1}]},options:w("Individual Wave Heights Distribution","Wave Number (#)","Wave Height H (m)",e=>{const t=e.dataIndex;return["Height: "+a[t].toFixed(3)+" m","Period: "+n[t].toFixed(2)+" s"]})}),h("wave-chart-title").textContent="Individual Wave Heights",h("wave-plot-container").style.display="block",x(q,"Wave Number (#)","Wave Height H (m)")},window.plotGaugeData=function(){if(!E)return alert("No gauge data");const e=parseFloat(h("time-step").value),t=E.map((t,a)=>(a*e).toFixed(3));f(S);const a=document.getElementById("reflection-plot").getContext("2d"),n=h("gauge-positions").value.split(",").map(e=>parseFloat(e.trim())),i=["#667eea","#f093fb","#4facfe"],r=[`Gauge 1 (x=${n[0]}m)`,`Gauge 2 (x=${n[1]}m)`,`Gauge 3 (x=${n[2]}m)`],o=[0,1,2].map(e=>({label:r[e],data:E.map(t=>t[e]),borderColor:i[e],backgroundColor:i[e]+"15",borderWidth:2,pointRadius:0,tension:.2,fill:!1}));S=new Chart(a,{type:"line",data:{labels:t,datasets:o},options:y("Three-Gauge Time Series Data","Time t (s)","Wave Elevation \u03b7 (m)")}),h("reflection-chart-title").textContent="Three-Gauge Data Comparison",h("reflection-plot-container").style.display="block",x(S,"Time t (s)","Wave Elevation \u03b7 (m)")},window.plotFrequencySpectrum=function(){if(!E)return alert("No gauge data");f(S);const e=E.map(e=>({re:e[0],im:0})),t=1/parseFloat(h("time-step").value),a=M.fft(e),n=a.length,i=[],r=[];for(let e=0;e<n/2;e++){i.push(e*t/n);const o=M.magnitude(a[e])/n;r.push(o*o/t)}const o=document.getElementById("reflection-plot").getContext("2d");S=new Chart(o,{type:"line",data:{labels:i,datasets:[{label:"Energy Spectrum",data:r,borderColor:"#667eea",backgroundColor:"rgba(102,126,234,0.1)",borderWidth:2,pointRadius:0,tension:.1,fill:!0}]},options:v("Frequency Spectrum Analysis (Gauge 1)","Frequency f (Hz)","Energy Spectrum (m\xb2/Hz)")}),h("reflection-chart-title").textContent="Wave Frequency Spectrum",h("reflection-plot-container").style.display="block",x(S,"Frequency f (Hz)","Energy Spectrum (m\xb2/Hz)")},window.resetWaveZoom=function(){q&&q.resetZoom&&q.resetZoom()},window.resetReflectionZoom=function(){S&&S.resetZoom&&S.resetZoom()},document.addEventListener("DOMContentLoaded",()=>{const t=["water-depth","wave-period","wave-data","sampling-frequency","gauge-positions","reflection-depth","time-step","gauge-data"].filter(e=>!h(e));if(t.length)a("Missing elements: "+t.join(","));else{e("Wave app initialized v1.1 (deterministic examples)");try{loadWavelengthExample(!1),calculateWavelength(),loadWaveStatsExample(!1),calculateWaveStats(),loadReflectionExample(!1),calculateReflection()}catch(n){a("Auto-load failed",n)}}})}();