!function(){"use strict";function e(e,t){console.log("[WaveApp] "+e,t||"")}function t(e,t){console.debug("[WaveApp][Debug] "+e,t||"")}function a(e,t){console.error("[WaveApp][Error] "+e,t)}function n(e,t,a=9.81){const n=2*Math.PI/t,i=n*n/a;let r=i;const o=1e-10;for(let t=0;t<100;t++){const t=(r*Math.tanh(r*e)-i)/(Math.tanh(r*e)+r*e*(1-Math.tanh(r*e)**2));if(r-=t,Math.abs(t)<o)break}return 2*Math.PI/r}function i(e,t){let a=e*e/M;for(let n=0;n<60;n++){const n=(M*a*Math.tanh(a*t)-e*e)/(M*Math.tanh(a*t)+M*a*t*(1/Math.cosh(a*t))**2);if(a-=n,Math.abs(n)<1e-10)break}return a}function r(e,t,a=.001){const n=e.length,i=e.reduce((e,t)=>e+t,0)/n,r=e.map(e=>e-i),o=[];for(let e=0;e<n-1;e++)if(r[e]<=0&&r[e+1]>0){const a=e*t-r[e]*t/(r[e+1]-r[e]);o.push(a)}const l=[];for(let e=0;e<o.length-1;e++){const i=o[e],s=o[e+1],c=Math.round(i/t),u=Math.round(s/t);if(u<n&&u>c){const e=r.slice(c,u+1),t=Math.max(...e)-Math.min(...e);t>a&&l.push({height:t,period:s-i,startTime:i,endTime:s})}}if(!l.length)return{nWaves:0,Hmean:0,Tmean:0,Hs:0,Ts:0,H10:0,waves:[]};const s=l.map(e=>e.height),c=l.map(e=>e.period),u=s.slice().sort((e,t)=>t-e),d=c.slice().sort((e,t)=>t-e),m=l.length,p=s.reduce((e,t)=>e+t,0)/m,h=c.reduce((e,t)=>e+t,0)/m,g=Math.floor(m/3),f=g?u.slice(0,g).reduce((e,t)=>e+t,0)/g:p,v=g?d.slice(0,g).reduce((e,t)=>e+t,0)/g:h,y=Math.floor(m/10);return{nWaves:m,Hmean:p,Tmean:h,Hs:f,Ts:v,H10:y?u.slice(0,y).reduce((e,t)=>e+t,0)/y:f,waves:l}}function o(e,t){return{re:e.re+t.re,im:e.im+t.im}}function l(e,t){return{re:e.re-t.re,im:e.im-t.im}}function s(e,t){return{re:e.re*t.re-e.im*t.im,im:e.re*t.im+e.im*t.re}}function c(e){return{re:e.re,im:-e.im}}function u(e,t){const a=t.re*t.re+t.im*t.im;return{re:(e.re*t.re+e.im*t.im)/a,im:(e.im*t.re-e.re*t.im)/a}}function d(e){return Math.hypot(e.re,e.im)}function m(e){try{const a=e.split(/\r?\n/),n=[],i=/[-+]?\d{1,3}(?:[ ,]?\d{3})*(?:[.,]\d+)?(?:[eE][-+]?\d+)?|[-+]?\d+(?:[.,]\d+)?(?:[eE][-+]?\d+)?/;for(const e of a){let t=e.trim();if(!t)continue;if(/^[a-zA-Z].*/.test(t)&&!i.test(t))continue;const a=t.match(i);if(a){let e=a[0];const t=e.includes(","),i=e.includes(".");if(t&&i){const t=e.lastIndexOf(","),a=e.lastIndexOf(".");t>a?(e=e.replace(/\./g,""),e=e.replace(",",".")):e=e.replace(/,/g,"")}else if(t&&!i)e=1===e.match(/,/g).length?e.replace(",","."):e.replace(/,/g,"");else if(i&&e.match(/\./g).length>1){const t=e.split("."),a=t.pop();e=t.join("")+"."+a}e=e.replace(/[ ]/g,"");const r=parseFloat(e);isFinite(r)&&n.push(r)}}return t("Parsed single column (enhanced)",{inputLines:a.length,parsed:n.length}),n}catch(e){return a("parseSingleColumnSeries failed",e),[]}}function p(e){try{const a=e.split(/\r?\n/),n=[],i=/[-+]?\d*\.?\d+(?:[eE][-+]?\d+)?/g;for(const e of a){if(!e)continue;const t=e.match(i);if(t&&t.length>=3){const e=t.slice(0,3).map(e=>parseFloat(e));e.every(e=>isFinite(e))&&n.push(e)}}return t("Parsed three gauge matrix",{inputLines:a.length,parsedRows:n.length}),n}catch(e){return a("parseThreeGaugeMatrix failed",e),[]}}function h(e,t){const a=e.reduce((e,t)=>e+d(t.c1)**2,0),n=e.reduce((e,t)=>e+d(t.c2)**2,0),i=e.reduce((e,t)=>o(e,s(c(t.c1),t.c2)),{re:0,im:0}),r=(i.re,i.im,a*n-(i.re*i.re+i.im*i.im));if(Math.abs(r)<1e-16)return null;const m=e.reduce((e,a,n)=>o(e,s(c(a.c1),t[n])),{re:0,im:0}),p=e.reduce((e,a,n)=>o(e,s(c(a.c2),t[n])),{re:0,im:0});return{Ai:u(l(s({re:n,im:0},m),s(i,p)),{re:r,im:0}),Ar:u(l(s({re:a,im:0},p),s(c(i),m)),{re:r,im:0})}}function g(e,a,n,r,o=.05,l=null){if(3!==a.length)throw new Error("Three-gauge analysis requires exactly 3 gauges");const s=a[0].length,c=W.isPowerOfTwo(s)?s:W.nextPowerOfTwo(s),u=a.map(e=>{const t=e.reduce((e,t)=>e+t,0)/e.length,a=e.map(e=>e-t);return a.length<c?a.concat(new Array(c-a.length).fill(0)):a}).map(e=>e.map(e=>({re:e,im:0}))).map(e=>W.fft(e)),m=1/n,p=u[0].length,g=Math.floor(p/2),f=m/p;l||(l=m/2*.95);const v=[],y=[],x=[],w=[];for(let t=1;t<g;t++){const a=t*f;if(a<o||a>l)continue;const n=i(2*Math.PI*a,r);if(!isFinite(n)||n<=0)continue;const s=h(e.map(e=>({c1:{re:Math.cos(-n*e),im:Math.sin(-n*e)},c2:{re:Math.cos(n*e),im:Math.sin(n*e)}})),[u[0][t],u[1][t],u[2][t]]);if(!s)continue;const c=d(s.Ai)/(p/2),m=d(s.Ar)/(p/2);c<1e-6&&m<1e-6||(v.push(c),y.push(m),x.push(a),w.push({f:a,k:n,AiMag:c,ArMag:m}))}if(!v.length)return{Hi:0,Hr:0,Kr:0,validFrequencies:0,details:[]};const b=2*(v.reduce((e,t)=>e+t,0)/v.length),F=2*(y.reduce((e,t)=>e+t,0)/y.length),M=v.reduce((e,t)=>e+t*t,0)*f/2,H=y.reduce((e,t)=>e+t*t,0)*f/2,E=4*Math.sqrt(Math.max(M,0)),C=4*Math.sqrt(Math.max(H,0)),S=E||b,q=C||F,T=S?q/S:0;return t("Reflection summary",{count:v.length,Hi_mean:b,Hr_mean:F,Hi_spec:E,Hr_spec:C,Kr:T}),{Hi:S,Hr:q,Kr:T,validFrequencies:v.length,details:w,Hi_mean:b,Hr_mean:F,Hi_spec:E,Hr_spec:C}}function f(e){return document.getElementById(e)}function v(e){if(e)try{e.destroy()}catch(e){a("Destroy chart failed",e)}}function y(e){return{display:!0,text:e,font:{size:16,weight:"bold",family:"Inter, sans-serif"},color:"#2c3e50"}}function x(e,t,a){return{responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!0,text:e,font:{size:16,weight:"bold"}},legend:{display:!0,position:"top"},tooltip:{mode:"index",intersect:!1}},scales:{x:{display:!0,title:y(t),grid:{color:"rgba(0,0,0,0.1)"},ticks:{font:{size:12,family:"Inter, sans-serif"},color:"#34495e"}},y:{display:!0,title:y(a),grid:{color:"rgba(0,0,0,0.1)"},ticks:{font:{size:12,family:"Inter, sans-serif"},color:"#34495e"}}},animation:{duration:1e3,easing:"easeInOutQuart"}}}function w(e,t,a){const n=x(e,t,a);return n.plugins.legend.labels={usePointStyle:!0,pointStyle:"line",font:{size:14}},n.plugins.zoom={zoom:{wheel:{enabled:!0},pinch:{enabled:!0},mode:"xy"},pan:{enabled:!0,mode:"xy"}},n}function b(e,t,a,n){return{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{title:{display:!0,text:e,font:{size:16,weight:"bold"}},legend:{display:!0,position:"top"},tooltip:{callbacks:{title:e=>"Wave #"+e[0].label,label:e=>n(e)}}},scales:{x:{display:!0,title:y(t),grid:{display:!1},ticks:{font:{size:12,family:"Inter, sans-serif"},color:"#34495e"}},y:{display:!0,title:y(a),beginAtZero:!0,grid:{color:"rgba(0,0,0,0.1)"},ticks:{font:{size:12,family:"Inter, sans-serif"},color:"#34495e"}}},animation:{duration:1e3,easing:"easeInOutQuart"}}}function F(e,t,a){if(!e)return;const n=e.options.scales||{};n.x&&(n.x.title||(n.x.title={}),n.x.title.display=!0,n.x.title.text=t),n.y&&(n.y.title||(n.y.title={}),n.y.title.display=!0,n.y.title.text=a),e.update()}const M=9.81;class W{static isPowerOfTwo(e){return e&&!(e&e-1)}static nextPowerOfTwo(e){return Math.pow(2,Math.ceil(Math.log2(e)))}static fft(e){const t=e.length;if(t<=1)return e;if(!this.isPowerOfTwo(t)){const a=this.nextPowerOfTwo(t),n=new Array(a).fill().map((a,n)=>n<t?e[n]:{re:0,im:0});return this.fft(n)}const a=new Array(t);for(let n=0;n<t;n++){let i=0;for(let e=1,a=n;e<t;e<<=1,a>>=1)i=i<<1|1&a;a[i]=e[n]}for(let e=2;e<=t;e*=2){const n=e/2,i={re:Math.cos(-2*Math.PI/e),im:Math.sin(-2*Math.PI/e)};for(let r=0;r<t;r+=e){let e={re:1,im:0};for(let t=0;t<n;t++){const o=a[r+t],l=r+t+n,s={re:a[l].re*e.re-a[l].im*e.im,im:a[l].re*e.im+a[l].im*e.re};a[r+t]={re:o.re+s.re,im:o.im+s.im},a[l]={re:o.re-s.re,im:o.im-s.im},e={re:e.re*i.re-e.im*i.im,im:e.re*i.im+e.im*i.re}}}}return a}static magnitude(e){return Math.hypot(e.re,e.im)}static phase(e){return Math.atan2(e.im,e.re)}}const H={depth:.3,waveFrequency:.75,samplingFrequency:100,gaugeSpacing:[0,.3,.9],generateData:function(e=20){const t=1/this.samplingFrequency,a=Math.floor(e/t),i=2*Math.PI*this.waveFrequency,r=1/this.waveFrequency,o=n(this.depth,r),l=2*Math.PI/o,s=.025,c=.008,u=.2,d=[];for(let e=0;e<a;e++){const a=e*t,n=[];for(let e=0;e<3;e++){const t=this.gaugeSpacing[e],r=s*Math.sin(l*t-i*a)+c*Math.sin(-l*t-i*a+u)+.003*Math.sin(1.5*i*a+.5*e);n.push(r.toFixed(6))}d.push(n)}return d}},E=H.generateData(20,20250208);let C=null,S=null,q=null,T=null,P=null;window.loadWavelengthExample=function(e=!0){f("water-depth").value=H.depth,f("wave-period").value=(1/H.waveFrequency).toFixed(2),e&&alert("Example loaded.")},window.calculateWavelength=function(){try{const e=parseFloat(f("water-depth").value),t=parseFloat(f("wave-period").value);if(!(e>0||t>0))return alert("Enter positive values.");const a=n(e,t),i=2*Math.PI/a,r=a/t,o=2*Math.PI/t,l=.5*(1+2*i*e/Math.sinh(2*i*e))*r;let s=e/a>.5?"Deep Water":e/a<.05?"Shallow Water":"Intermediate Water";f("wavelength-value").textContent=a.toFixed(3),f("wavelength-details").innerHTML=`<strong>Additional Parameters:</strong><br>\u2022 Wave Number (k): ${i.toFixed(4)} rad/m<br>\u2022 Wave Celerity (c): ${r.toFixed(2)} m/s<br>\u2022 Group Velocity (cg): ${l.toFixed(2)} m/s<br>\u2022 Relative Depth (h/L): ${(e/a).toFixed(3)}<br>\u2022 Water Regime: ${s}<br>\u2022 Angular Frequency: ${o.toFixed(3)} rad/s`,f("wavelength-result").style.display="block"}catch(e){a("Wavelength calc failed",e),alert("Error calculating wavelength.")}},window.loadWaveStatsExample=function(e=!0){const t=E.map(e=>parseFloat(e[0]));f("wave-data").value=t.map(e=>e.toFixed(6)).join("\n"),f("sampling-frequency").value=H.samplingFrequency,e&&alert("Wave stats example loaded.")},window.calculateWaveStats=function(){try{const e=f("wave-data").value.trim(),t=parseFloat(f("sampling-frequency").value);if(!(e&&t>0))return alert("Enter data and valid frequency");const a=m(e);if(!a.length)return void alert("No numeric values parsed. Ensure you pasted only one column.");if(a.length<10)return alert("Need at least 10 points (parsed "+a.length+")");const n=1/t,i=r(a,n);if(!i.nWaves)return alert("No valid waves found");C=a,S=i;const o=a.length*n,l=i.waves.map(e=>e.height),s=Math.max(...l),c=Math.min(...l),u=Math.sqrt(l.reduce((e,t)=>e+(t-i.Hmean)**2,0)/i.nWaves);f("hs-value").textContent=i.Hs.toFixed(3),f("hmean-value").textContent=i.Hmean.toFixed(3),f("tmean-value").textContent=i.Tmean.toFixed(2),f("h10-value").textContent=i.H10.toFixed(3),f("wave-count-value").textContent=i.nWaves;const d=f("wave-stats-result");let p=d.querySelector(".additional-results");p||(p=document.createElement("div"),p.className="additional-results",d.appendChild(p)),p.innerHTML=`<strong>Extended Statistics:</strong><br>\u2022 Maximum Wave Height: ${s.toFixed(3)} m<br>\u2022 Minimum Wave Height: ${c.toFixed(3)} m<br>\u2022 Standard Deviation: ${u.toFixed(3)} m<br>\u2022 Significant Period (Ts): ${i.Ts.toFixed(2)} s<br>\u2022 Data Duration: ${o.toFixed(1)} s<br>\u2022 Sampling Rate: ${t} Hz<br>\u2022 Data Points: ${a.length}<br>\u2022 Parsing: Excel/CSV compatible (first numeric per row used)`,d.style.display="block",f("wave-stats-plot-controls").style.display="block"}catch(e){a("Wave stats failed",e),alert("Error analyzing wave data (see console).")}},window.loadReflectionExample=function(e=!0){f("gauge-positions").value=H.gaugeSpacing.join(", "),f("reflection-depth").value=H.depth,f("time-step").value=1/H.samplingFrequency;const t=E;f("gauge-data").value=t.map(e=>e.join(",")).join("\n"),e&&alert("Reflection example loaded.")},window.calculateReflection=function(){try{const e=f("gauge-positions").value.split(",").map(e=>parseFloat(e.trim())),a=parseFloat(f("reflection-depth").value),n=parseFloat(f("time-step").value),i=f("gauge-data").value.trim();if(3!==e.length||e.some(isNaN)||!(a>0)||!(n>0)||!i)return alert("Enter valid inputs");const r=p(i);if(r.length<10)return alert("Need at least 10 rows with 3+ columns");q=r;const o=g(e,[r.map(e=>e[0]),r.map(e=>e[1]),r.map(e=>e[2])],n,a);f("hi-value").textContent=o.Hi.toFixed(3),f("hr-value").textContent=o.Hr.toFixed(3),f("kr-value").textContent=o.Kr.toFixed(3),f("freq-count-value").textContent=o.validFrequencies;const l=f("reflection-result");let s=l.querySelector(".additional-results");s||(s=document.createElement("div"),s.className="additional-results",l.appendChild(s));const c=o.Kr;let u=c<.3?"Low reflection - Good absorption":c<.7?"Moderate reflection - Partial absorption":"High reflection - Strong reflection";const d=r.length*n,m=Math.abs(e[1]-e[0]),h=(c*c*100).toFixed(1);s.innerHTML=`<strong>Analysis Details:</strong><br>\u2022 Gauge Spacing: ${m.toFixed(2)} m<br>\u2022 Data Duration: ${d.toFixed(1)} s<br>\u2022 Performance: ${u}<br>\u2022 Energy Reflection: ${h}%<br>\u2022 Data Points: ${r.length}<br>\u2022 Method: 3-gauge LSQ (freq-domain)<br>\u2022 Parsing: Excel/CSV/tab delimited accepted (first 3 numerics per row)`,l.style.display="block",f("reflection-plot-controls").style.display="block",t("Reflection frequencies sample",o.details.slice(0,5))}catch(e){a("Reflection failed",e),alert("Error analyzing reflection")}},window.plotWaveTimeSeries=function(){if(!C)return alert("No wave data");const e=1/parseFloat(f("sampling-frequency").value),t=C.map((t,a)=>(a*e).toFixed(3));v(T);const a=document.getElementById("wave-plot").getContext("2d");T=new Chart(a,{type:"line",data:{labels:t,datasets:[{label:"Wave Elevation (m)",data:C,borderColor:"#667eea",backgroundColor:"rgba(102,126,234,0.1)",borderWidth:2,pointRadius:0,tension:.1,fill:!0}]},options:x("Wave Time Series","Time t (s)","Wave Elevation \u03b7 (m)")}),f("wave-chart-title").textContent="Wave Time Series Plot",f("wave-plot-container").style.display="block",F(T,"Time t (s)","Wave Elevation \u03b7 (m)")},window.plotWaveHeights=function(){if(!S||!S.waves.length)return alert("No wave analysis results");const e=S.waves,t=e.map((e,t)=>t+1),a=e.map(e=>e.height),n=e.map(e=>e.period);v(T);const i=document.getElementById("wave-plot").getContext("2d");T=new Chart(i,{type:"bar",data:{labels:t,datasets:[{label:"Wave Height (m)",data:a,backgroundColor:"rgba(79,172,254,0.7)",borderColor:"#4facfe",borderWidth:2,borderRadius:4,borderSkipped:!1}]},options:b("Individual Wave Heights Distribution","Wave Number (#)","Wave Height H (m)",e=>{const t=e.dataIndex;return["Height: "+a[t].toFixed(3)+" m","Period: "+n[t].toFixed(2)+" s"]})}),f("wave-chart-title").textContent="Individual Wave Heights",f("wave-plot-container").style.display="block",F(T,"Wave Number (#)","Wave Height H (m)")},window.plotGaugeData=function(){if(!q)return alert("No gauge data");const e=parseFloat(f("time-step").value),t=q.map((t,a)=>(a*e).toFixed(3));v(P);const a=document.getElementById("reflection-plot").getContext("2d"),n=f("gauge-positions").value.split(",").map(e=>parseFloat(e.trim())),i=["#667eea","#f093fb","#4facfe"],r=[`Gauge 1 (x=${n[0]}m)`,`Gauge 2 (x=${n[1]}m)`,`Gauge 3 (x=${n[2]}m)`],o=[0,1,2].map(e=>({label:r[e],data:q.map(t=>t[e]),borderColor:i[e],backgroundColor:i[e]+"15",borderWidth:2,pointRadius:0,tension:.2,fill:!1}));P=new Chart(a,{type:"line",data:{labels:t,datasets:o},options:w("Three-Gauge Time Series Data","Time t (s)","Wave Elevation \u03b7 (m)")}),f("reflection-chart-title").textContent="Three-Gauge Data Comparison",f("reflection-plot-container").style.display="block",F(P,"Time t (s)","Wave Elevation \u03b7 (m)")},window.plotGaugeData=function(){if(!q)return alert("No gauge data");const e=parseFloat(f("time-step").value),t=q.map((t,a)=>(a*e).toFixed(3)),a=f("gauge-positions").value.split(",").map(e=>parseFloat(e.trim())),n=["#667eea","#f093fb","#4facfe"],i=[`Gauge 1 (x=${a[0]}m)`,`Gauge 2 (x=${a[1]}m)`,`Gauge 3 (x=${a[2]}m)`],r=[0,1,2].map(e=>({x:t,y:q.map(t=>t[e]),mode:"lines",name:i[e],line:{color:n[e],width:2}}));Plotly.newPlot("reflection-plot",r,{title:"Three-Gauge Time Series Data",xaxis:{title:"Time t (s)"},yaxis:{title:"Wave Elevation \u03b7 (m)"},legend:{orientation:"h"},margin:{t:40,l:60,r:30,b:50},autosize:!0},{responsive:!0}),f("reflection-chart-title").textContent="Three-Gauge Data Comparison",f("reflection-plot-container").style.display="block"},window.plotFrequencySpectrum=function(){if(!q)return alert("No gauge data");v(P);const e=q.map(e=>({re:e[0],im:0})),t=1/parseFloat(f("time-step").value),a=W.fft(e),n=a.length,i=[],r=[];for(let e=0;e<n/2;e++){i.push(e*t/n);const o=W.magnitude(a[e])/n;r.push(o*o/t)}const o=document.getElementById("reflection-plot").getContext("2d");P=new Chart(o,{type:"line",data:{labels:i,datasets:[{label:"Energy Spectrum",data:r,borderColor:"#667eea",backgroundColor:"rgba(102,126,234,0.1)",borderWidth:2,pointRadius:0,tension:.1,fill:!0}]},options:x("Frequency Spectrum Analysis (Gauge 1)","Frequency f (Hz)","Energy Spectrum (m\xb2/Hz)")}),f("reflection-chart-title").textContent="Wave Frequency Spectrum",f("reflection-plot-container").style.display="block",F(P,"Frequency f (Hz)","Energy Spectrum (m\xb2/Hz)")},window.plotFrequencySpectrum=function(){if(!q)return alert("No gauge data");const e=q.map(e=>({re:e[0],im:0})),t=1/parseFloat(f("time-step").value),a=W.fft(e),n=a.length,i=[],r=[];for(let e=0;e<n/2;e++){i.push(e*t/n);const o=W.magnitude(a[e])/n;r.push(o*o/t)}Plotly.newPlot("reflection-plot",[{x:i,y:r,type:"scatter",mode:"lines",name:"Energy Spectrum",line:{color:"#667eea",width:2},fill:"tozeroy",fillcolor:"rgba(102,126,234,0.1)"}],{title:"Frequency Spectrum Analysis (Gauge 1)",xaxis:{title:"Frequency f (Hz)"},yaxis:{title:"Energy Spectrum (m\xb2/Hz)"},margin:{t:40,l:60,r:30,b:50},autosize:!0},{responsive:!0}),f("reflection-chart-title").textContent="Wave Frequency Spectrum",f("reflection-plot-container").style.display="block"},window.resetWaveZoom=function(){T&&T.resetZoom&&T.resetZoom()},window.resetReflectionZoom=function(){P&&P.resetZoom&&P.resetZoom()},document.addEventListener("DOMContentLoaded",()=>{const t=["water-depth","wave-period","wave-data","sampling-frequency","gauge-positions","reflection-depth","time-step","gauge-data"].filter(e=>!f(e));if(t.length)a("Missing elements: "+t.join(","));else{e("Wave app initialized v1.1 (deterministic examples)");try{loadWavelengthExample(!1),calculateWavelength(),loadWaveStatsExample(!1),calculateWaveStats(),loadReflectionExample(!1),calculateReflection()}catch(e){a("Auto-load failed",e)}}})}();